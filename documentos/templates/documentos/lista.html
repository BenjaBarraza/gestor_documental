{% extends 'documentos/base.html' %}
{% load etiquetas_tags %}


{% block title %}Tus Documentos | Gestor Documental{% endblock %}

{% block content %}
<div class="header d-flex justify-content-between align-items-center flex-wrap gap-3 mb-4">
  <h2 class="mb-0">Tus Documentos</h2>
  <a href="{% url 'documentos:home' %}" class="btn btn-secondary">🏠 Inicio</a>
</div>

{% if documentos %}
  <ul class="list-group shadow-sm">
    {% for doc in documentos %}
      <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div class="flex-grow-1">
          <!-- Icono por tipo -->
          {% with ext=doc.archivo.name|slice:"-4:"|lower %}
            {% if ext == ".pdf" %}
              📄
            {% elif ext == ".doc" or ext == "docx" %}
              📝
            {% elif ext == ".xls" or ext == "xlsx" %}
              📊
            {% elif ext == ".png" or ext == ".jpg" %}
              🖼️
            {% else %}
              📁
            {% endif %}
          {% endwith %}
          <a href="{% url 'documentos:previsualizar' doc.id %}" class="fw-semibold text-decoration-none text-primary">
            {{ doc.nombre }}
          </a>
          <br>
          <small class="text-muted">👤 Subido por: {{ doc.usuario.username }}</small><br>
          <small class="text-muted">📅 {{ doc.fecha_subida|date:"d/m/Y" }} a las {{ doc.fecha_subida|date:"H:i" }}</small>
          
          <!-- Etiquetas -->
          {% if doc.etiquetas_lista %}
            <div class="mt-1">
              {% for etiqueta in doc.etiquetas_lista %}
                <span class="badge bg-secondary">{{ etiqueta }}</span>
              {% endfor %}
            </div>
          {% endif %}
        </div>

        <div class="d-flex align-items-center gap-2">
          <!-- Tipo de archivo visual -->
          {% with ext=doc.archivo.name|slice:"-4:"|upper %}
            {% if ext == ".PDF" %}
              <span class="badge bg-danger">{{ ext }}</span>
            {% elif ext == ".JPG" or ext == ".PNG" %}
              <span class="badge bg-info">{{ ext }}</span>
            {% elif ext == ".DOC" or ext == "XLSX" %}
              <span class="badge bg-warning text-dark">{{ ext }}</span>
            {% else %}
              <span class="badge bg-dark">{{ ext }}</span>
            {% endif %}
          {% endwith %}

          <!-- Botón eliminar -->
          <button class="delete-btn" onclick='confirmDelete({{ doc.id }}, "{{ doc.nombre|escapejs }}")' title="Eliminar documento">🗑️</button>
        </div>
      </li>
    {% endfor %}
  </ul>
{% else %}
  <div class="alert alert-secondary text-center mt-4">
    <p class="mb-2">No tienes documentos aún.</p>
    <a href="{% url 'documentos:subir' %}" class="btn btn-success">＋ Subir tu primer documento</a>
  </div>
{% endif %}

<!-- Buscador -->
<form method="get" action="{% url 'documentos:buscar' %}" class="search-form mt-4 d-flex flex-wrap gap-2">
  <input type="text" name="q" placeholder="Buscar por nombre, etiqueta o tipo..." class="form-control">
  <button type="submit" class="btn btn-primary">🔍 Buscar</button>
</form>

<!-- Modal de confirmación -->
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <h3>¿Eliminar documento?</h3>
    <p>Estás a punto de eliminar el documento: <strong id="docNameToDelete"></strong></p>
    <p>Esta acción no se puede deshacer.</p>
    <div class="modal-actions">
      <button onclick="closeModal()" class="btn btn-secondary">Cancelar</button>
      <button id="confirmDeleteBtn" class="btn btn-danger">Eliminar definitivamente</button>
    </div>
  </div>
</div>

<script>
  let currentDocId = null;

  function confirmDelete(docId, docName) {
    currentDocId = docId;
    document.getElementById('docNameToDelete').textContent = docName;
    document.getElementById('deleteModal').style.display = 'flex';
  }

  function closeModal() {
    document.getElementById('deleteModal').style.display = 'none';
    currentDocId = null;
  }

  document.getElementById('confirmDeleteBtn').addEventListener('click', function () {
    if (currentDocId) deleteDocument(currentDocId);
  });

  function deleteDocument(docId) {
    fetch(`/eliminar/${docId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json',
      },
    })
    .then((response) => response.json())
    .then((data) => {
      if (data.success || data.status === 'success') window.location.reload();
      else alert('Error al eliminar: ' + (data.error || 'Error desconocido'));
    })
    .catch((error) => alert('Error de red al eliminar: ' + error.message))
    .finally(() => closeModal());
  }

  document.getElementById('deleteModal').addEventListener('click', function (e) {
    if (e.target === this) closeModal();
  });
</script>
{% endblock %}
